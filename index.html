<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="POSTECH ì›Œí¬ìˆ ë§Œì°¬ìš© ëª¨ë°”ì¼ ë¹™ê³ ê²Œì„">
  <title>ëª¨ë°”ì¼ ë¹™ê³ ê²Œì„</title>
  <style>
    /* CSS ë³€ìˆ˜ ì„¤ì • */
    :root {
      --postech-red: #C0001A;
      --postech-green: #009E60;
      --bg-light: #F5F5F5;
      --text-dark: #333333;
      --radius: 8px;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    /* ê¸°ë³¸ ë¦¬ì…‹ */
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-light); color: var(--text-dark); }
    /* í™”ë©´ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .screen { display: none; padding: 1rem; height: 100%; overflow-y: auto; }
    .screen.active { display: block; }
    h2 { font-size: 1.5rem; margin-bottom: 1rem; }
    p { margin: 0.5rem 0; }
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn { display: inline-block; text-align: center; padding: 0.75rem 1.5rem; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 500; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.1s, background-color 0.2s; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: var(--postech-red); color: #fff; }
    .btn-secondary { background: var(--postech-green); color: #fff; }
    /* ì…ë ¥ í•„ë“œ */
    input[type="text"], input[type="password"] { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: var(--radius); font-size: 1rem; }
    input:focus { outline: 2px solid var(--postech-red); }
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner { display: none; width: 2rem; height: 2rem; border: 4px solid var(--bg-light); border-top-color: var(--postech-red); border-radius: 50%; animation: spin 1s linear infinite; margin: 1rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ë¹™ê³ íŒ ê·¸ë¦¬ë“œ */
    .bingo-grid { display: grid; gap: 4px; margin: 1rem 0; }
    .bingo-cell { background: #fff; border: 1px solid #ddd; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; padding: 0.5rem; font-size: 0.85rem; border-radius: var(--radius); transition: background-color 0.2s; }
    .bingo-cell.checked { background: var(--postech-green); color: #fff; }
    /* ë­í‚¹ ë°°ë„ˆ */
    .ranking-banner { background: var(--postech-red); color: #fff; padding: 0.5rem; text-align: center; font-size: 1rem; font-weight: bold; }
    /* ë§í¬ ìŠ¤íƒ€ì¼ */
    a { color: var(--postech-red); word-break: break-all; }
    /* ë°˜ì‘í˜• í°íŠ¸ */
    @media (min-width: 400px) { body { font-size: 1.1rem; } }
  </style>
</head>
<body>
  <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
  <div id="spinner" class="spinner"></div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ -->
  <section id="screen-admin-login" class="screen active">
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
    <button class="btn btn-primary" id="btn-admin-login">ë¡œê·¸ì¸</button>
    <p id="admin-login-error" style="color:red;"></p>
  </section>

  <!-- ê´€ë¦¬ì ì„¤ì • í™”ë©´ -->
  <section id="screen-admin-setup" class="screen">
    <h2>ê²Œì„ ì„¤ì •</h2>
    <label for="config-size">ë¹™ê³  í¬ê¸° (3~5)</label>
    <input type="text" id="config-size" value="5" />
    <label for="config-winCount">ë¹™ê³  ì¤„ìˆ˜ (1~2)</label>
    <input type="text" id="config-winCount" value="1" />
    <button class="btn btn-secondary" id="btn-save-config">ì €ì¥</button>
    <button class="btn btn-primary" id="btn-create-game">ê²Œì„ ìƒì„±</button>
    <p id="setup-message"></p>
  </section>

  <!-- ì°¸ê°€ í™”ë©´ -->
  <section id="screen-join" class="screen">
    <h2>ë¹™ê³ ê²Œì„ ì°¸ê°€</h2>
    <input type="text" id="user-nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (1~20ì)" />
    <button class="btn btn-primary" id="btn-join">ì°¸ê°€í•˜ê¸°</button>
    <p id="join-error" style="color:red;"></p>
  </section>

  <!-- ê²Œì„ í™”ë©´ -->
  <section id="screen-game" class="screen">
    <div class="ranking-banner" id="current-ranking">ìˆœìœ„: --</div>
    <h2>ë¹™ê³ íŒ</h2>
    <div id="bingo-grid" class="bingo-grid"></div>
    <p>ë¹™ê³  ë‹¬ì„± ì‹œ ìë™ ì¸ì¦ë©ë‹ˆë‹¤!</p>
  </section>

  <!-- ê²°ê³¼ í™”ë©´ -->
  <section id="screen-result" class="screen">
    <h2>ğŸ‰ ë¹™ê³  ë‹¬ì„±! ğŸ‰</h2>
    <p id="result-message"></p>
    <button class="btn btn-primary" id="btn-continue">ê³„ì†í•˜ê¸°</button>
  </section>

  <script>
    // API ìš”ì²­ í—¬í¼
    async function apiRequest(path, options = {}) {
      const spinner = document.getElementById('spinner');
      spinner.style.display = 'block';
      try {
        const res = await fetch((window.BASE_URL||'') + path, options);
        const data = await res.json();
        spinner.style.display = 'none';
        return data;
      } catch (e) {
        spinner.style.display = 'none';
        alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        console.error(e);
      }
    }

    // í™”ë©´ ì „í™˜
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // ê´€ë¦¬ì ë¡œê·¸ì¸
    document.getElementById('btn-admin-login').onclick = async () => {
      const pwd = document.getElementById('admin-password').value.trim();
      if (!pwd) return document.getElementById('admin-login-error').innerText = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
      const data = await apiRequest('/api/admin/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password: pwd}) });
      if (data.token) {
        localStorage.setItem('adminToken', data.token);
        showScreen('screen-admin-setup');
      } else document.getElementById('admin-login-error').innerText = data.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
    };

    // ì„¤ì • ì €ì¥
    document.getElementById('btn-save-config').onclick = async () => {
      const size = parseInt(document.getElementById('config-size').value);
      const winCount = parseInt(document.getElementById('config-winCount').value);
      const token = localStorage.getItem('adminToken');
      const gameId = localStorage.getItem('gameId');
      const data = await apiRequest(`/api/admin/game/${gameId}/config`, { method: 'PUT', headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token}, body: JSON.stringify({size, winCount}) });
      document.getElementById('setup-message').innerText = data.error || 'ì„¤ì • ì €ì¥ ì™„ë£Œ';
    };

    // ê²Œì„ ìƒì„±
    document.getElementById('btn-create-game').onclick = async () => {
      const token = localStorage.getItem('adminToken');
      const data = await apiRequest('/api/admin/game', { method: 'POST', headers: {'Authorization': 'Bearer ' + token} });
      if (data.gameId) {
        localStorage.setItem('gameId', data.gameId);
        document.getElementById('setup-message').innerHTML = `ì°¸ê°€ URL: <a href="${data.joinUrl}" target="_blank">${data.joinUrl}</a>`;
        showScreen('screen-join');
      }
    };

    // ì°¸ê°€
    document.getElementById('btn-join').onclick = async () => {
      const nick = document.getElementById('user-nickname').value.trim();
      if (!nick || nick.length > 20) return document.getElementById('join-error').innerText = 'ìœ íš¨í•œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.';
      const gameId = localStorage.getItem('gameId');
      const data = await apiRequest('/api/user/join', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({gameId, nickname: nick}) });
      if (data.userId) {
        localStorage.setItem('userId', data.userId);
        renderBingoCard(data.card);
        showScreen('screen-game');
      } else document.getElementById('join-error').innerText = data.error;
    };

    // ë¹™ê³ íŒ ë Œë”ë§
    function renderBingoCard(card) {
      const grid = document.getElementById('bingo-grid');
      grid.style.gridTemplateColumns = `repeat(${card.length}, 1fr)`;
      grid.innerHTML = ''; card.flat().forEach(val => {
        const cell = document.createElement('div'); cell.className = 'bingo-cell'; cell.innerText = val;
        cell.onclick = () => handleCellClick(cell, val);
        grid.appendChild(cell);
      });
    }

    // ì…€ í´ë¦­
    async function handleCellClick(cell, value) {
      if (cell.classList.contains('checked')) return;
      const gameId = localStorage.getItem('gameId'), userId = localStorage.getItem('userId');
      const data = await apiRequest(`/api/game/${gameId}/user/${userId}/check`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({value}) });
      if (data.checkedCells) { cell.classList.add('checked'); checkBingo(); }
    }

    // ë¹™ê³  ì¸ì¦
    async function checkBingo() {
      const gameId = localStorage.getItem('gameId'), userId = localStorage.getItem('userId');
      const data = await apiRequest(`/api/game/${gameId}/user/${userId}/bingo`, { method: 'POST' });
      if (data.isBingo) {
        document.getElementById('result-message').innerText = `ìˆœìœ„: ${data.rank} ìœ„!`;
        showScreen('screen-result');
      } else updateRanking();
    }

    // ìˆœìœ„ ì—…ë°ì´íŠ¸
    async function updateRanking() {
      const gameId = localStorage.getItem('gameId');
      const data = await apiRequest(`/api/game/${gameId}/ranking?limit=1`);
      if (data.ranking && data.ranking.length) document.getElementById('current
