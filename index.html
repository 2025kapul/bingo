<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š KDC ë„ì„œê´€ ë¹™ê³  ê²Œì„ - 2025 ì‚¬ëŒ€ë„í˜‘ ì‚¬ë¬´êµ­</title>
    <style>
        /* --- ê¸°ë³¸ & ë ˆì´ì•„ì›ƒ --- */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --secondary-color: #6b7280;
            --light-gray: #f3f4f6;
            --text-dark: #1f2937;
            --text-light: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.7;
            font-size: 16px;
        }

        .container {
            max-width: 520px;
            margin: 0 auto;
            padding: 1rem;
        }

        .container-wide {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .header {
            text-align: center;
            padding: 2rem 0 1rem;
        }

        .title {
            font-size: 2.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #818cf8, #fbcfe8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        /* --- ë²„íŠ¼ --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            min-height: 48px;
            user-select: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            background-color: #9ca3af;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:not(:disabled):active {
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }

        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }

        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }

        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }

        .btn-small { padding: 0.5rem 0.75rem; font-size: 0.875rem; min-height: 38px; }
        .btn-full { width: 100%; }

        /* --- ì…ë ¥ í•„ë“œ --- */
        .input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            background: white;
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        /* --- ì»´í¬ë„ŒíŠ¸ --- */
        .status-bar { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .status-badge { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.875rem; font-weight: 500; }
        .status-online { background: rgba(16, 185, 129, 0.15); color: #065f46; }
        .status-offline { background: rgba(239, 68, 68, 0.15); color: #991b1b; }

        .room-info { background: rgba(255, 255, 255, 0.2); border-radius: 0.5rem; padding: 0.75rem; text-align: center; margin-bottom: 1rem; color: white; font-weight: 500;}
        .room-code { font-family: 'SF Mono', monospace; font-weight: 700; background: white; color: var(--primary-color); padding: 0.25rem 0.75rem; border-radius: 0.25rem; margin: 0 0.25rem; border: 1px solid #e2e8f0; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: var(--light-gray); border-radius: 0.75rem; padding: 1rem; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 800; margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.8rem; opacity: 0.8; font-weight: 600; text-transform: uppercase; }
        .stat-blue { color: #3b82f6; } .stat-green { color: #10b981; } .stat-purple { color: #8b5cf6; } .stat-orange { color: #f59e0b; }

        /* --- ë¹™ê³  ì¹´ë“œ --- */
        .bingo-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; background: #e0e7ff; padding: 0.75rem; border-radius: 0.75rem; margin-bottom: 1rem; }
        .bingo-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 0.375rem;
            font-size: 0.75rem; /* ê°€ë…ì„± í–¥ìƒ */
            font-weight: 600;
            text-align: center;
            padding: 0.25rem;
            position: relative;
            transition: all 0.3s ease;
            min-height: 60px;
            line-height: 1.3; /* ì¤„ ê°„ê²© ì¶”ê°€ */
            word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ */
        }

        .bingo-cell.marked {
            background: var(--primary-color);
            color: white;
            transform: rotateY(360deg);
            border-color: var(--primary-hover);
        }

        .bingo-cell.center {
            background: var(--warning-color);
            color: white;
            border-color: #d97706;
        }

        .bingo-cell.marked::after {
            content: 'âœ“';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 1rem;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0,0,0,0.2);
        }
        
        /* --- ë¦¬ë”ë³´ë“œ --- */
        .leaderboard { max-height: 320px; overflow-y: auto; padding-right: 5px; }
        .player-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; margin-bottom: 0.5rem; background: var(--light-gray); border-radius: 0.5rem; }
        .player-info { display: flex; align-items: center; gap: 0.75rem; }
        .player-rank { width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; color: white; }
        .rank-1 { background: #fbbf24; } .rank-2 { background: #a1a1aa; } .rank-3 { background: #fb923c; } .rank-other { background: #d1d5db; color: var(--text-dark); }
        .player-current { background: #c7d2fe; border: 2px solid var(--primary-color); }
        .bingo-badge { background: var(--danger-color); color: white; padding: 0.25rem 0.6rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; }

        /* --- ëª¨ë‹¬ --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 1rem; padding: 2rem; max-width: 420px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        /* --- ê¸°íƒ€ --- */
        .control-panel { background: var(--light-gray); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .current-topic { background: #e0e7ff; border-left: 4px solid var(--primary-color); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .range-container { display: flex; align-items: center; gap: 0.75rem; margin: 0.5rem 0; }
        .range-input { flex: 1; -webkit-appearance: none; background: #d1d5db; height: 6px; border-radius: 3px; outline: none; }
        .range-input::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; }
        .range-value { background: white; border: 1px solid #e2e8f0; border-radius: 0.25rem; padding: 0.5rem; min-width: 3.5rem; text-align: center; font-weight: 700; }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mb-3 { margin-bottom: 1.5rem; }
        .gap-2 { gap: 0.5rem; } .gap-3 { gap: 0.75rem; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }

        .loading { text-align: center; padding: 3rem 1rem; color: white; }
        .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .footer { text-align: center; padding: 2rem 0; color: rgba(255, 255, 255, 0.85); font-size: 0.875rem; }

        /* --- ë°˜ì‘í˜• --- */
        @media (max-width: 640px) {
            .title { font-size: 2.25rem; }
            .card { padding: 1.25rem; }
            .bingo-cell { font-size: 0.65rem; min-height: 50px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1024px) {
            .admin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <h2>ğŸ“š KDC ë¹™ê³  ë¡œë”©ì¤‘...</h2>
        <p>ê²Œì„ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
    </div>

    <div id="app" class="hidden">
        <!-- í™”ë©´ë“¤ (ì„ íƒ, ê´€ë¦¬ì, í”Œë ˆì´ì–´) -->
        <div id="select-screen">
            <div class="container">
                <div class="header">
                    <h1 class="title">ğŸ“š KDC ë„ì„œê´€ ë¹™ê³ </h1>
                    <p class="subtitle">í•œêµ­ì‹­ì§„ë¶„ë¥˜ë²• ê¸°ë°˜ êµìœ¡ ë¹™ê³  ê²Œì„</p>
                </div>
                <div class="status-bar">
                    <div id="connection" class="status-badge status-online">ğŸŒ ì‹¤ì‹œê°„ ì—°ê²°</div>
                    <button id="share-game-btn" class="btn btn-small btn-primary">ğŸ”— ê²Œì„ ê³µìœ </button>
                </div>
                <div class="room-info">
                    <span>ğŸ¢ ê²Œì„ ë£¸: <span id="room-code-display" class="room-code"></span></span>
                </div>
                <div class="card">
                    <h2 class="text-center mb-2">ğŸ¯ ê²Œì„ ì°¸ì—¬</h2>
                    <div id="shared-notice" class="hidden" style="background: rgba(16, 185, 129, 0.1); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; text-align: center; color: #065f46;">
                        ğŸ‰ ê³µìœ  ë§í¬ë¡œ ì ‘ì†í•˜ì…¨ìŠµë‹ˆë‹¤!
                    </div>
                    <div class="flex flex-col gap-3">
                        <button id="admin-mode-btn" class="btn btn-danger btn-full">ğŸ” ê´€ë¦¬ìë¡œ ê²Œì„ ì§„í–‰</button>
                        <input id="player-name-input" type="text" class="input" placeholder="ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
                        <button id="join-game-btn" class="btn btn-primary btn-full" disabled>ğŸ‘¥ ì°¸ê°€ìë¡œ ê²Œì„ ì°¸ì—¬</button>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center justify-between mb-2">
                        <h3>ğŸ“Š ê²Œì„ í˜„í™©</h3>
                        <button id="refresh-btn" class="btn btn-small btn-secondary">ğŸ”„</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div id="total-players" class="stat-number stat-blue">0</div><div class="stat-label">ì°¸ê°€ì</div></div>
                        <div class="stat-card"><div id="called-topics" class="stat-number stat-green">0</div><div class="stat-label">í˜¸ì¶œ ì£¼ì œ</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-screen" class="hidden">
            <div class="container-wide">
                <div class="header">
                    <h1 style="color: white;">ğŸ‘‘ ê´€ë¦¬ì íŒ¨ë„</h1>
                    <div class="status-bar">
                        <button id="back-to-main" class="btn btn-small btn-secondary">â† ë©”ì¸ìœ¼ë¡œ</button>
                        <div id="admin-connection" class="status-badge status-online">ğŸŒ ì‹¤ì‹œê°„ ì—°ê²°</div>
                        <button id="share-admin-btn" class="btn btn-small btn-primary">ğŸ”— ì°¸ê°€ì ë§í¬</button>
                        <button id="change-password-btn" class="btn btn-small btn-danger">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </div>
                    <div class="room-info">ë£¸: <span id="admin-room-code" class="room-code"></span></div>
                </div>
                <div class="admin-grid">
                    <div class="card">
                        <h3 class="mb-2">ğŸ® ê²Œì„ ì»¨íŠ¸ë¡¤</h3>
                        <div class="control-panel">
                            <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem; display: block;">ğŸ¯ ë¹™ê³  ì™„ì„± ì¡°ê±´ (ì¤„ ìˆ˜)</label>
                            <div class="range-container">
                                <input id="bingo-range" type="range" min="1" max="5" value="3" class="range-input">
                                <div class="range-value"><span id="bingo-value">3</span>ì¤„</div>
                            </div>
                            <div id="range-warning" class="hidden" style="color: var(--warning-color); font-size: 0.75rem; margin-top: 0.5rem;">âš ï¸ ê²Œì„ ì¤‘ì—ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <button id="game-toggle" class="btn btn-success" style="flex: 1;">â–¶ï¸ ê²Œì„ ì‹œì‘</button>
                            <button id="reset-game" class="btn btn-secondary">ğŸ”„</button>
                        </div>
                        <button id="call-topic" class="btn btn-primary btn-full" disabled>ğŸ“¢ ë‹¤ìŒ ì£¼ì œ í˜¸ì¶œ</button>
                        <div id="current-topic-card" class="current-topic hidden">
                            <div style="font-weight: 600; color: #1d4ed8; margin-bottom: 0.25rem;">ìµœê·¼ í˜¸ì¶œ:</div>
                            <div id="current-topic-name" style="font-size: 1.25rem; font-weight: 700; color: #1e3a8a;"></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="mb-2">ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</h3>
                        <div class="stats-grid">
                            <div class="stat-card"><div id="admin-players" class="stat-number stat-blue">0</div><div class="stat-label">ì°¸ê°€ì</div></div>
                            <div class="stat-card"><div id="admin-topics" class="stat-number stat-green">0</div><div class="stat-label">í˜¸ì¶œë¨</div></div>
                            <div class="stat-card"><div id="admin-condition" class="stat-number stat-purple">3</div><div class="stat-label">ì™„ì„±ì¡°ê±´</div></div>
                            <div class="stat-card"><div id="admin-completed" class="stat-number stat-orange">0</div><div class="stat-label">ì™„ì„±ì</div></div>
                        </div>
                        <div>
                            <h4 class="mb-1">ìµœê·¼ í˜¸ì¶œ ì£¼ì œ:</h4>
                            <div id="topics-history" style="max-height: 120px; overflow-y: auto; background: var(--light-gray); padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;"></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="mb-2">ğŸ† ì‹¤ì‹œê°„ ìˆœìœ„ (<span id="rank-count">0</span>ëª…)</h3>
                        <div id="admin-leaderboard" class="leaderboard"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="player-screen" class="hidden">
            <div class="container">
                <div class="header">
                    <h1 id="player-title" style="color: white;"></h1>
                    <div class="status-bar">
                        <button id="player-back" class="btn btn-small btn-secondary">â† ë©”ì¸ìœ¼ë¡œ</button>
                        <div id="player-connection" class="status-badge status-online">ğŸŒ ì‹¤ì‹œê°„ ì—°ê²°</div>
                    </div>
                    <div class="room-info">ë£¸: <span id="player-room-code" class="room-code"></span></div>
                </div>
                <div class="card">
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-card"><div id="my-lines" class="stat-number stat-blue">0</div><div class="stat-label">ë¹™ê³  ì¤„</div><div id="my-bingo-status" class="hidden bingo-badge" style="margin-top: 0.25rem;">âœ… BINGO!</div></div>
                        <div class="stat-card"><div id="my-rank" class="stat-number stat-green">#-</div><div class="stat-label">ìˆœìœ„</div><div id="my-medal" style="font-size: 1.25rem;"></div></div>
                        <div class="stat-card"><div id="my-condition" class="stat-number stat-purple">3</div><div class="stat-label">ì™„ì„±ì¡°ê±´</div></div>
                    </div>
                </div>
                <div id="player-current-topic" class="current-topic hidden">
                    <div style="font-weight: 600; color: #1d4ed8; font-size: 0.875rem;">ğŸ”Š ìµœê·¼ í˜¸ì¶œ:</div>
                    <div id="player-topic-name" style="font-size: 1.125rem; font-weight: 700; color: #1e3a8a;"></div>
                </div>
                <div class="card">
                    <div id="player-bingo-card" class="bingo-card"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë§ì¶¤í˜• ëª¨ë‹¬ (ì•Œë¦¼, í™•ì¸) -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-center mb-3"></h3>
            <p id="modal-text" class="text-center mb-3" style="color: var(--text-light);"></p>
            <div id="modal-buttons" class="flex gap-3"></div>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-center mb-3">ğŸ” ê´€ë¦¬ì ì¸ì¦</h3>
            <div id="password-setup" class="hidden">
                <div style="background: rgba(245, 158, 11, 0.1); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; text-align: center;">
                    <strong>ğŸ”‘ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”</strong><br><small>4ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</small>
                </div>
                <div class="mb-2"><label class="mb-1" style="font-weight: 600;">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input id="new-password" type="password" class="input" placeholder="1234" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;"></div>
                <div class="mb-2"><label class="mb-1" style="font-weight: 600;">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="confirm-password" type="password" class="input" placeholder="1234" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;"></div>
            </div>
            <div id="password-verify">
                <div style="background: rgba(79, 70, 229, 0.1); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; text-align: center;"><strong>ğŸ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</strong></div>
                <div class="mb-2"><label class="mb-1" style="font-weight: 600;">ë¹„ë°€ë²ˆí˜¸</label><input id="verify-password" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;"></div>
                <div class="text-center mb-2"><button id="forgot-password" class="btn btn-small btn-secondary">ğŸ”„ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button></div>
            </div>
            <div id="password-error" class="hidden" style="background: rgba(239, 68, 68, 0.1); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; text-align: center; color: #991b1b;"></div>
            <div class="flex gap-3">
                <button id="password-confirm" class="btn btn-primary" style="flex: 1;" disabled>ğŸ”“ í™•ì¸</button>
                <button id="password-cancel" class="btn btn-secondary" style="flex: 1;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ê³µìœ  ëª¨ë‹¬ -->
    <div id="share-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 class="text-center mb-3">ğŸ”— ì°¸ê°€ì ë§í¬ ê³µìœ </h3>
            <div class="mb-2">
                <label class="mb-1" style="font-weight: 600;">ê²Œì„ ë£¸ ì½”ë“œ</label>
                <div class="flex gap-2">
                    <div id="share-room-code" class="room-code" style="flex: 1; text-align: center; padding: 0.75rem; font-size: 1.25rem;"></div>
                    <button id="copy-room" class="btn btn-small btn-secondary">ğŸ“‹</button>
                </div>
            </div>
            <div class="mb-2">
                <label class="mb-1" style="font-weight: 600;">ì°¸ê°€ì ì „ìš© ë§í¬</label>
                <div id="share-url" style="background: var(--light-gray); padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; word-break: break-all; max-height: 4rem; overflow-y: auto; border: 1px solid #e2e8f0;"></div>
            </div>
            <div class="flex gap-3">
                <button id="share-link" class="btn btn-primary" style="flex: 1;">ğŸ“± ë§í¬ ê³µìœ </button>
                <button id="close-share" class="btn btn-secondary" style="flex: 1;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>


    <div class="footer">
        ğŸ“š Made by <strong>2025 ì‚¬ëŒ€ë„í˜‘ ì‚¬ë¬´êµ­</strong>
    </div>

    <script>
        // KDC ì£¼ì œ ë°ì´í„°
        const KDC_TOPICS = [
            'ë„ì„œê´€í•™', 'ì •ë³´í•™', 'ë°±ê³¼ì‚¬ì „', 'ë…¼ë¬¸ì‘ì„±ë²•', 'ì»´í“¨í„°ê³¼í•™', 'ì¸í„°ë„·', 'ì €ë„ë¦¬ì¦˜', 'ì‹ ë¬¸í•™', 'ì¡ì§€í•™', 'ì¶œíŒí•™',
            'í˜•ì´ìƒí•™', 'ì¸ì‹ë¡ ', 'ë…¼ë¦¬í•™', 'ìœ¤ë¦¬í•™', 'ë¯¸í•™', 'ì‹¬ë¦¬í•™', 'ì² í•™ì‚¬', 'ë™ì–‘ì² í•™', 'ì„œì–‘ì² í•™', 'ì¢…êµì² í•™',
            'ê¸°ë…êµ', 'ë¶ˆêµ', 'ì´ìŠ¬ëŒêµ', 'íŒë‘êµ', 'ìœ êµ', 'ë„êµ', 'ì‹ í™”í•™', 'ì¢…êµì‚¬', 'ì¢…êµì² í•™', 'ì¢…êµë¬¸í™”',
            'ì‚¬íšŒí•™', 'ì •ì¹˜í•™', 'í–‰ì •í•™', 'ë²•í•™', 'ê²½ì œí•™', 'í†µê³„í•™', 'êµìœ¡í•™', 'ë¯¼ì†í•™', 'êµ­ë°©í•™', 'ì‚¬íšŒë¬¸ì œ',
            'ìˆ˜í•™', 'ë¬¼ë¦¬í•™', 'í™”í•™', 'ìƒë¬¼í•™', 'ì§€êµ¬ê³¼í•™', 'ì²œë¬¸í•™', 'ê¸°ìƒí•™', 'ì§€ì§ˆí•™', 'ìƒíƒœí•™', 'í™˜ê²½ê³¼í•™',
            'ì˜í•™', 'ê³µí•™', 'ë†í•™', 'ê±´ì¶•í•™', 'ê¸°ê³„ê³µí•™', 'ì „ìê³µí•™', 'ì»´í“¨í„°ê³µí•™', 'í™”í•™ê³µí•™', 'í† ëª©ê³µí•™', 'ì‚°ì—…ê³µí•™',
            'ë¯¸ìˆ ', 'ì¡°ê°', 'ê³µì˜ˆ', 'ì„œì˜ˆ', 'íšŒí™”', 'ê±´ì¶•ì˜ˆìˆ ', 'ì‚¬ì§„', 'ìŒì•…', 'ë¬´ìš©', 'ì—°ê·¹',
            'ì–¸ì–´í•™', 'í•œêµ­ì–´', 'ì¤‘êµ­ì–´', 'ì¼ë³¸ì–´', 'ì˜ì–´', 'ë…ì¼ì–´', 'í”„ë‘ìŠ¤ì–´', 'ìŠ¤í˜ì¸ì–´', 'ëŸ¬ì‹œì•„ì–´', 'ì•„ëì–´',
            'ë¬¸í•™ì´ë¡ ', 'í•œêµ­ë¬¸í•™', 'ì¤‘êµ­ë¬¸í•™', 'ì¼ë³¸ë¬¸í•™', 'ì˜ë¯¸ë¬¸í•™', 'ë…ì¼ë¬¸í•™', 'í”„ë‘ìŠ¤ë¬¸í•™', 'ì‹œë¬¸í•™', 'ì†Œì„¤', 'í¬ê³¡',
            'ì—­ì‚¬í•™', 'í•œêµ­ì‚¬', 'ë™ì–‘ì‚¬', 'ì„œì–‘ì‚¬', 'ì„¸ê³„ì‚¬', 'ê³ ê³ í•™', 'ì „ê¸°', 'ì§€ë¦¬í•™', 'ì—¬í–‰ê¸°', 'ë¬¸í™”ì‚¬'
        ];

        class BingoGame {
            constructor() {
                // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
                this.gameRoom = '';
                this.gameMode = 'select';
                this.gameState = 'waiting';
                this.calledTopics = [];
                this.currentTopic = '';
                this.players = new Map();
                this.playerId = '';
                this.playerName = '';
                this.playerCard = [];
                this.requiredBingoLines = 3;
                this.isSharedLink = false;
                this.lastUpdate = Date.now();
                
                // íš¨ê³¼ìŒ ê´€ë ¨
                this.audioCtx = null;
                this.prevPlayerCount = 0;
                this.myPrevBingoLines = 0;

                // UI ìš”ì†Œ ìºì‹±
                this.ui = {};
                this.cacheDOMElements();
                
                this.init();
            }

            // DOM ìš”ì†Œë¥¼ í•œë²ˆë§Œ ì°¾ì•„ì™€ì„œ ë³€ìˆ˜ì— ì €ì¥ (ì„±ëŠ¥ í–¥ìƒ)
            cacheDOMElements() {
                const ids = [
                    'loading', 'app', 'select-screen', 'admin-screen', 'player-screen',
                    'connection', 'admin-connection', 'player-connection', 'share-game-btn',
                    'room-code-display', 'admin-room-code', 'player-room-code', 'shared-notice',
                    'admin-mode-btn', 'player-name-input', 'join-game-btn', 'refresh-btn',
                    'total-players', 'called-topics', 'back-to-main', 'share-admin-btn',
                    'change-password-btn', 'bingo-range', 'bingo-value', 'range-warning',
                    'game-toggle', 'reset-game', 'call-topic', 'current-topic-card',
                    'current-topic-name', 'admin-players', 'admin-topics', 'admin-condition',
                    'admin-completed', 'topics-history', 'rank-count', 'admin-leaderboard',
                    'player-title', 'player-back', 'my-lines', 'my-bingo-status', 'my-rank',
                    'my-medal', 'my-condition', 'player-current-topic', 'player-topic-name',
                    'player-bingo-card', 'custom-modal', 'modal-title', 'modal-text', 'modal-buttons',
                    'password-modal', 'password-setup', 'password-verify', 'new-password',
                    'confirm-password', 'verify-password', 'forgot-password', 'password-error',
                    'password-confirm', 'password-cancel', 'share-modal', 'share-room-code',
                    'copy-room', 'share-url', 'share-link', 'close-share'
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.ui[camelCaseId] = document.getElementById(id);
                });
            }

            init() {
                this.setupEventListeners();
                this.loadGameState();
                this.startSync();
                this.checkConnection();
                this.hideLoading();
            }

            hideLoading() {
                this.ui.loading.classList.add('hidden');
                this.ui.app.classList.remove('hidden');
            }

            // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í•œ ê³³ì—ì„œ ì„¤ì •
            setupEventListeners() {
                const buttons = [
                    this.ui.adminModeBtn, this.ui.joinGameBtn, this.ui.shareGameBtn,
                    this.ui.refreshBtn, this.ui.backToMain, this.ui.shareAdminBtn,
                    this.ui.changePasswordBtn, this.ui.gameToggle, this.ui.resetGame,
                    this.ui.callTopic, this.ui.playerBack, this.ui.passwordConfirm,
                    this.ui.passwordCancel, this.ui.forgotPassword, this.ui.copyRoom,
                    this.ui.shareLink, this.ui.closeShare
                ];
                buttons.forEach(btn => {
                    if (btn) btn.addEventListener('click', () => this.playSound('click'));
                });

                this.ui.adminModeBtn.addEventListener('click', () => this.showPasswordModal());
                this.ui.joinGameBtn.addEventListener('click', () => this.joinAsPlayer());
                this.ui.shareGameBtn.addEventListener('click', () => this.showShareModal());
                this.ui.refreshBtn.addEventListener('click', () => this.refreshGame());
                
                this.ui.playerNameInput.addEventListener('input', (e) => {
                    this.ui.joinGameBtn.disabled = !e.target.value.trim();
                });
                this.ui.playerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) this.joinAsPlayer();
                });

                this.ui.backToMain.addEventListener('click', () => this.showScreen('select'));
                this.ui.shareAdminBtn.addEventListener('click', () => this.showShareModal());
                this.ui.changePasswordBtn.addEventListener('click', () => this.changePassword());
                this.ui.gameToggle.addEventListener('click', () => this.toggleGame());
                this.ui.resetGame.addEventListener('click', () => this.resetGame());
                this.ui.callTopic.addEventListener('click', () => this.callTopic());

                this.ui.playerBack.addEventListener('click', () => this.showScreen('select'));

                this.ui.bingoRange.addEventListener('input', (e) => this.setRequiredLines(parseInt(e.target.value)));

                this.ui.passwordConfirm.addEventListener('click', () => this.confirmPassword());
                this.ui.passwordCancel.addEventListener('click', () => this.hidePasswordModal());
                this.ui.forgotPassword.addEventListener('click', () => this.resetPassword());

                ['newPassword', 'confirmPassword', 'verifyPassword'].forEach(id => {
                    this.ui[id].addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                        this.validatePassword();
                    });
                    this.ui[id].addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.confirmPassword();
                    });
                });

                this.ui.copyRoom.addEventListener('click', () => this.copyText(this.gameRoom, 'ë£¸ ì½”ë“œ'));
                this.ui.shareLink.addEventListener('click', () => this.shareLink());
                this.ui.closeShare.addEventListener('click', () => this.hideShareModal());
            }

            // --- ì‚¬ìš´ë“œ ì²˜ë¦¬ ---
            initAudio() {
                if (this.audioCtx) return;
                try {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn("Web Audio API is not supported in this browser.");
                }
            }

            playSound(type) {
                if (!this.audioCtx) return;

                const now = this.audioCtx.currentTime;
                const oscillator = this.audioCtx.createOscillator();
                const gainNode = this.audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioCtx.destination);
                gainNode.gain.setValueAtTime(0, now);

                switch (type) {
                    case 'click':
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(600, now);
                        gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                        gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                        break;
                    case 'join':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(523.25, now);
                        gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01);
                        oscillator.frequency.setValueAtTime(659.25, now + 0.1);
                        gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                        break;
                    case 'line':
                         oscillator.type = 'sine';
                         oscillator.frequency.setValueAtTime(880, now);
                         gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                         gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                        break;
                    case 'bingo':
                        ['G5', 'A5', 'B5', 'C6'].forEach((note, i) => {
                            const frequencies = { G5: 783.99, A5: 880.00, B5: 987.77, C6: 1046.50 };
                            const freq = frequencies[note];
                            const time = now + i * 0.1;
                            const osc = this.audioCtx.createOscillator();
                            const gn = this.audioCtx.createGain();
                            osc.type = 'sine';
                            osc.connect(gn);
                            gn.connect(this.audioCtx.destination);
                            osc.frequency.setValueAtTime(freq, time);
                            gn.gain.setValueAtTime(0.3, time);
                            gn.gain.exponentialRampToValueAtTime(0.0001, time + 0.2);
                            osc.start(time);
                            osc.stop(time + 0.2);
                        });
                        return; // ì»¤ìŠ¤í…€ ë¡œì§ì´ë¯€ë¡œ ì—¬ê¸°ì„œ ì¢…ë£Œ
                }
                
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            }

            // --- ë§ì¶¤í˜• ëª¨ë‹¬ í•¨ìˆ˜ ---
            showAlert(title, text, onOk) {
                this.ui.modalTitle.textContent = title;
                this.ui.modalText.textContent = text;
                this.ui.modalButtons.innerHTML = `<button id="modal-ok" class="btn btn-primary btn-full">í™•ì¸</button>`;
                this.ui.customModal.classList.add('visible');
                
                document.getElementById('modal-ok').onclick = () => {
                    this.playSound('click');
                    this.ui.customModal.classList.remove('visible');
                    if (onOk) onOk();
                };
            }

            showConfirm(title, text, onConfirm, onCancel) {
                this.ui.modalTitle.textContent = title;
                this.ui.modalText.textContent = text;
                this.ui.modalButtons.innerHTML = `
                    <button id="modal-confirm" class="btn btn-danger" style="flex:1;">í™•ì¸</button>
                    <button id="modal-cancel" class="btn btn-secondary" style="flex:1;">ì·¨ì†Œ</button>
                `;
                this.ui.customModal.classList.add('visible');

                document.getElementById('modal-confirm').onclick = () => {
                    this.playSound('click');
                    this.ui.customModal.classList.remove('visible');
                    if (onConfirm) onConfirm();
                };
                document.getElementById('modal-cancel').onclick = () => {
                    this.playSound('click');
                    this.ui.customModal.classList.remove('visible');
                    if (onCancel) onCancel();
                };
            }

            // --- ìƒíƒœ ê´€ë¦¬ ---
            loadGameState() {
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('room');
                
                if (roomId) {
                    this.gameRoom = roomId;
                    if (urlParams.get('mode') === 'player') {
                        this.isSharedLink = true;
                        this.ui.adminModeBtn.classList.add('hidden');
                        this.ui.sharedNotice.classList.remove('hidden');
                        this.ui.shareGameBtn.classList.add('hidden');
                    }
                    const saved = this.loadSavedState(this.gameRoom);
                    if (saved) {
                        this.restoreState(saved);
                    } else {
                        // If there's a room ID but no state, create a default one
                        this.saveState();
                    }
                } else {
                    this.gameRoom = this.generateRoomId();
                    this.updateUrl();
                    this.saveState(); // Save initial empty state
                }
                this.prevPlayerCount = this.players.size;
                this.updateUI();
            }

            generateRoomId() {
                return Math.random().toString(36).substr(2, 8).toUpperCase();
            }

            updateUrl() {
                try {
                    const params = new URLSearchParams();
                    params.set('room', this.gameRoom);
                    if (this.isSharedLink) params.set('mode', 'player');
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.replaceState({}, '', newUrl);
                } catch (e) {
                    console.warn("URLì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë³´ì•ˆ ì œì•½ í™˜ê²½)", e.message);
                }
            }

            loadSavedState(roomId) {
                try {
                    const saved = localStorage.getItem(`kdc-bingo-${roomId}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (Date.now() - data.lastUpdate < 24 * 60 * 60 * 1000) {
                            return data;
                        }
                    }
                } catch (e) { console.error("ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:", e); }
                return null;
            }

            saveState() {
                try {
                    const state = {
                        calledTopics: this.calledTopics,
                        currentTopic: this.currentTopic,
                        gameState: this.gameState,
                        requiredBingoLines: this.requiredBingoLines,
                        players: Array.from(this.players.entries()),
                        lastUpdate: Date.now()
                    };
                    localStorage.setItem(`kdc-bingo-${this.gameRoom}`, JSON.stringify(state));
                } catch (e) { console.error("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", e); }
            }

            restoreState(saved) {
                this.calledTopics = saved.calledTopics || [];
                this.currentTopic = saved.currentTopic || '';
                this.gameState = saved.gameState || 'waiting';
                this.requiredBingoLines = saved.requiredBingoLines || 3;
                this.players = new Map(saved.players || []);
                this.lastUpdate = saved.lastUpdate || Date.now();
            }

            startSync() {
                setInterval(() => {
                    this.loadRemoteState();
                }, 1500); // Poll slightly faster
            }

            loadRemoteState() {
                const saved = this.loadSavedState(this.gameRoom);
                if (saved && saved.lastUpdate > this.lastUpdate) {
                    this.restoreState(saved);
                    this.updatePlayerCard(); // Update player card if in player mode
                    this.updateUI(); // Update UI with the new state
                }
            }

            checkConnection() {
                setInterval(() => {
                    const online = navigator.onLine;
                    [this.ui.connection, this.ui.adminConnection, this.ui.playerConnection].forEach(el => {
                        if (el) {
                            el.className = `status-badge ${online ? 'status-online' : 'status-offline'}`;
                            el.textContent = online ? 'ğŸŒ ì‹¤ì‹œê°„ ì—°ê²°' : 'ğŸ“µ ì˜¤í”„ë¼ì¸';
                        }
                    });
                }, 3000);
            }

            showScreen(screen) {
                ['select', 'admin', 'player'].forEach(s => {
                    this.ui[`${s}Screen`].classList.add('hidden');
                });
                this.ui[`${screen}Screen`].classList.remove('hidden');
                this.gameMode = screen;
                this.updateUI();
            }

            // --- ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ (SHA-256 í•´ì‹± ì‚¬ìš©) ---
            async hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password + this.gameRoom); // ì†”íŠ¸(salt)ë¡œ ë£¸ ID ì‚¬ìš©
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async showPasswordModal() {
                this.initAudio();
                const hasPwd = await this.hasPassword();
                this.ui.passwordSetup.classList.toggle('hidden', hasPwd);
                this.ui.passwordVerify.classList.toggle('hidden', !hasPwd);
                this.clearPasswordInputs();
                this.ui.passwordModal.classList.add('visible');
                
                if (hasPwd) this.ui.verifyPassword.focus();
                else this.ui.newPassword.focus();
            }

            hidePasswordModal() {
                this.ui.passwordModal.classList.remove('visible');
                this.clearPasswordInputs();
                this.hidePasswordError();
            }

            async hasPassword() {
                return localStorage.getItem(`admin-pwd-hash-${this.gameRoom}`) !== null;
            }

            async savePassword(password) {
                const hash = await this.hashPassword(password);
                localStorage.setItem(`admin-pwd-hash-${this.gameRoom}`, hash);
            }

            async verifyPassword(password) {
                const storedHash = localStorage.getItem(`admin-pwd-hash-${this.gameRoom}`);
                if (!storedHash) return false;
                const inputHash = await this.hashPassword(password);
                return storedHash === inputHash;
            }

            async confirmPassword() {
                this.initAudio();
                const hasPwd = await this.hasPassword();
                
                if (hasPwd) {
                    const password = this.ui.verifyPassword.value;
                    if (await this.verifyPassword(password)) {
                        this.hidePasswordModal();
                        this.showScreen('admin');
                    } else {
                        this.showPasswordError('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                    }
                } else {
                    const newPwd = this.ui.newPassword.value;
                    const confirmPwd = this.ui.confirmPassword.value;
                    
                    if (newPwd.length !== 4) {
                        this.showPasswordError('4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                        return;
                    }
                    if (newPwd !== confirmPwd) {
                        this.showPasswordError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                        return;
                    }
                    
                    await this.savePassword(newPwd);
                    this.hidePasswordModal();
                    this.showScreen('admin');
                    this.showAlert('ğŸ” ì„¤ì • ì™„ë£Œ', 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            }

            validatePassword() {
                this.hasPassword().then(hasPwd => {
                    const confirmBtn = this.ui.passwordConfirm;
                    if (hasPwd) {
                        const password = this.ui.verifyPassword.value;
                        confirmBtn.disabled = password.length !== 4;
                        confirmBtn.textContent = 'ğŸ”“ ë¡œê·¸ì¸';
                    } else {
                        const newPwd = this.ui.newPassword.value;
                        const confirmPwd = this.ui.confirmPassword.value;
                        const valid = newPwd.length === 4 && confirmPwd.length === 4;
                        confirmBtn.disabled = !valid;
                        confirmBtn.textContent = 'ğŸ” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •';
                        
                        if (valid && newPwd !== confirmPwd) this.showPasswordError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                        else this.hidePasswordError();
                    }
                });
            }

            showPasswordError(msg) {
                this.ui.passwordError.textContent = `âŒ ${msg}`;
                this.ui.passwordError.classList.remove('hidden');
            }

            hidePasswordError() { this.ui.passwordError.classList.add('hidden'); }

            clearPasswordInputs() {
                ['newPassword', 'confirmPassword', 'verifyPassword'].forEach(id => { this.ui[id].value = ''; });
                this.validatePassword();
            }

            changePassword() {
                this.showConfirm('ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½', 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚­ì œë©ë‹ˆë‹¤.', () => {
                    localStorage.removeItem(`admin-pwd-hash-${this.gameRoom}`);
                    this.showPasswordModal();
                });
            }

            resetPassword() {
                this.showConfirm('ğŸ”„ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                    localStorage.removeItem(`admin-pwd-hash-${this.gameRoom}`);
                    this.hidePasswordModal();
                    this.showPasswordModal();
                });
            }

            // --- ê³µìœ  ê¸°ëŠ¥ ---
            showShareModal() {
                this.ui.shareRoomCode.textContent = this.gameRoom;
                this.ui.shareUrl.textContent = `${window.location.origin}${window.location.pathname}?room=${this.gameRoom}&mode=player`;
                this.ui.shareModal.classList.add('visible');
            }

            hideShareModal() { this.ui.shareModal.classList.remove('visible'); }

            shareLink() {
                const url = `${window.location.origin}${window.location.pathname}?room=${this.gameRoom}&mode=player`;
                if (navigator.share) {
                    navigator.share({
                        title: 'ğŸ“š KDC ë„ì„œê´€ ë¹™ê³  ê²Œì„',
                        text: 'í•¨ê»˜ ë¹™ê³  ê²Œì„ì— ì°¸ì—¬í•˜ì„¸ìš”!',
                        url: url
                    }).catch(() => this.copyText(url, 'ë§í¬'));
                } else {
                    this.copyText(url, 'ë§í¬');
                }
            }

            copyText(text, type) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showAlert('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ', `${type}ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }).catch(() => {
                    this.showAlert('âš ï¸ ë³µì‚¬ ì‹¤íŒ¨', 'í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                });
            }

            // --- ê²Œì„ ë¡œì§ (Read-Modify-Write íŒ¨í„´ ì ìš©) ---
            performStateUpdate(updateFunction) {
                // 1. READ: ìµœì‹  ìƒíƒœë¥¼ ì½ì–´ì˜µë‹ˆë‹¤.
                const latestState = this.loadSavedState(this.gameRoom);
                if (latestState) {
                    this.restoreState(latestState);
                }

                // 2. MODIFY: ì „ë‹¬ëœ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
                updateFunction.call(this);

                // 3. WRITE: ë³€ê²½ëœ ìµœì‹  ìƒíƒœë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
                this.saveState();

                // 4. ì¦‰ì‹œ ìì‹ ì˜ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                this.updateUI();
            }

            joinAsPlayer() {
                this.initAudio();
                const name = this.ui.playerNameInput.value.trim();
                if (!name) return;

                this.performStateUpdate(() => {
                    this.playerName = name;
                    this.playerId = `player_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                    this.playerCard = this.generateBingoCard();
                    this.playerCard[12].marked = true; // ê°€ìš´ë° FREE

                    this.calledTopics.forEach(topic => {
                        this.playerCard.forEach(cell => {
                            if (cell.topic === topic) cell.marked = true;
                        });
                    });

                    this.players.set(this.playerId, {
                        id: this.playerId,
                        name: this.playerName,
                        card: this.playerCard,
                        bingoLines: this.checkBingo(this.playerCard),
                        joinTime: Date.now()
                    });
                    
                    this.myPrevBingoLines = this.checkBingo(this.playerCard);
                    this.showScreen('player');
                });
            }

            generateBingoCard() {
                const shuffled = [...KDC_TOPICS].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, 25).map((topic, index) => ({
                    id: index, topic, marked: false, isCenter: index === 12
                }));
            }

            checkBingo(card) {
                const grid = Array.from({ length: 5 }, (_, i) => card.slice(i * 5, (i + 1) * 5));
                let count = 0;
                // ê°€ë¡œ, ì„¸ë¡œ
                for (let i = 0; i < 5; i++) {
                    if (grid[i].every(cell => cell.marked)) count++;
                    if (grid.every(row => row[i].marked)) count++;
                }
                // ëŒ€ê°ì„ 
                if (grid.every((row, i) => row[i].marked)) count++;
                if (grid.every((row, i) => row[4 - i].marked)) count++;
                return count;
            }

            isBingoComplete(lines) { return lines >= this.requiredBingoLines; }

            toggleGame() {
                this.performStateUpdate(() => {
                    this.gameState = this.gameState === 'playing' ? 'paused' : 'playing';
                });
            }

            resetGame() {
                this.showConfirm('ğŸ”„ ê²Œì„ ì´ˆê¸°í™”', 'ì •ë§ë¡œ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì°¸ê°€ì ì •ë³´ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.', () => {
                    this.performStateUpdate(() => {
                        this.calledTopics = [];
                        this.currentTopic = '';
                        this.gameState = 'waiting';
                        this.players.clear();
                        this.requiredBingoLines = 3;
                    });
                });
            }

            callTopic() {
                this.performStateUpdate(() => {
                    const uncalled = KDC_TOPICS.filter(topic => !this.calledTopics.includes(topic));
                    if (uncalled.length === 0) {
                        this.showAlert('ğŸ‰ ì¢…ë£Œ', 'ëª¨ë“  ì£¼ì œë¥¼ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤!');
                        return;
                    }

                    const topic = uncalled[Math.floor(Math.random() * uncalled.length)];
                    this.currentTopic = topic;
                    this.calledTopics.push(topic);
                    
                    this.players.forEach((player, id) => {
                        const updatedCard = player.card.map(cell => 
                            cell.topic === topic ? { ...cell, marked: true } : cell
                        );
                        this.players.set(id, {
                            ...player,
                            card: updatedCard,
                            bingoLines: this.checkBingo(updatedCard)
                        });
                    });

                    this.updatePlayerCard();
                });
            }

            updatePlayerCard() {
                if (this.gameMode === 'player' && this.playerId) {
                    if (this.players.has(this.playerId)) {
                        const player = this.players.get(this.playerId);
                        this.playerCard = player.card;
                    }
                }
            }

            setRequiredLines(lines) {
                if (this.gameState === 'playing' && this.calledTopics.length > 0) return;
                this.performStateUpdate(() => {
                    this.requiredBingoLines = lines;
                });
            }

            refreshGame() {
                this.loadRemoteState();
            }

            getLeaderboard() {
                return Array.from(this.players.values())
                    .sort((a, b) => {
                        if (b.bingoLines !== a.bingoLines) return b.bingoLines - a.bingoLines;
                        return a.joinTime - b.joinTime;
                    });
            }

            // --- UI ì—…ë°ì´íŠ¸ ---
            updateUI() {
                this.updateRoomInfo();
                this.updateStats();
                if (this.gameMode === 'admin') this.updateAdminUI();
                if (this.gameMode === 'player') this.updatePlayerUI();
            }

            updateRoomInfo() {
                [this.ui.roomCodeDisplay, this.ui.adminRoomCode, this.ui.playerRoomCode].forEach(el => {
                    if(el) el.textContent = this.gameRoom;
                });
            }

            updateStats() {
                const playerCount = this.players.size;
                const topicCount = this.calledTopics.length;
                this.ui.totalPlayers.textContent = playerCount;
                this.ui.calledTopics.textContent = topicCount;
            }

            updateAdminUI() {
                const playerCount = this.players.size;
                if (playerCount > this.prevPlayerCount) {
                    this.playSound('join');
                }
                this.prevPlayerCount = playerCount;

                const topicCount = this.calledTopics.length;
                this.ui.adminPlayers.textContent = playerCount;
                this.ui.adminTopics.textContent = topicCount;
                this.ui.adminCondition.textContent = this.requiredBingoLines;
                
                const leaderboard = this.getLeaderboard();
                this.ui.adminCompleted.textContent = leaderboard.filter(p => this.isBingoComplete(p.bingoLines)).length;
                this.ui.rankCount.textContent = playerCount;

                // Game Controls
                const toggleBtn = this.ui.gameToggle;
                if (this.gameState === 'playing') {
                    toggleBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                    toggleBtn.className = 'btn btn-full btn-warning';
                } else {
                    toggleBtn.textContent = 'â–¶ï¸ ê²Œì„ ì‹œì‘';
                    toggleBtn.className = 'btn btn-full btn-success';
                }
                const remaining = KDC_TOPICS.length - this.calledTopics.length;
                this.ui.callTopic.textContent = `ğŸ“¢ ë‹¤ìŒ ì£¼ì œ í˜¸ì¶œ (${remaining}ê°œ ë‚¨ìŒ)`;
                this.ui.callTopic.disabled = this.gameState !== 'playing' || remaining === 0;
                
                this.ui.bingoRange.value = this.requiredBingoLines;
                this.ui.bingoValue.textContent = this.requiredBingoLines;
                const gameActive = this.gameState === 'playing' && this.calledTopics.length > 0;
                this.ui.bingoRange.disabled = gameActive;
                this.ui.rangeWarning.classList.toggle('hidden', !gameActive);

                this.updateCurrentTopic('admin');
                this.updateLeaderboard(leaderboard);
                this.updateTopicsHistory();
            }

            updatePlayerUI() {
                this.ui.playerTitle.textContent = `ğŸ¯ ${this.playerName}ë‹˜ì˜ ë¹™ê³ `;
                this.ui.myCondition.textContent = this.requiredBingoLines;

                if (this.playerId && this.players.has(this.playerId)) {
                    const player = this.players.get(this.playerId);
                    const leaderboard = this.getLeaderboard();
                    const rank = leaderboard.findIndex(p => p.id === this.playerId) + 1;
                    
                    const newBingoLines = player.bingoLines;
                    const isNowComplete = this.isBingoComplete(newBingoLines);
                    const wasComplete = this.isBingoComplete(this.myPrevBingoLines);

                    if (newBingoLines > this.myPrevBingoLines) {
                        if (isNowComplete && !wasComplete) {
                            this.playSound('bingo');
                        } else {
                            this.playSound('line');
                        }
                    }
                    this.myPrevBingoLines = newBingoLines;

                    this.ui.myLines.textContent = newBingoLines;
                    this.ui.myLines.style.color = isNowComplete ? 'var(--danger-color)' : 'var(--primary-color)';
                    this.ui.myRank.textContent = rank ? `#${rank}` : '#-';
                    this.ui.myBingoStatus.classList.toggle('hidden', !isNowComplete);
                    
                    const medals = ['ğŸ‘‘', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                    this.ui.myMedal.textContent = (rank > 0 && rank <= 3) ? medals[rank - 1] : '';
                }
                this.updateCurrentTopic('player');
                this.updateBingoCard();
            }

            updateCurrentTopic(mode) {
                const card = this.ui[mode === 'admin' ? 'currentTopicCard' : 'playerCurrentTopic'];
                const name = this.ui[mode === 'admin' ? 'currentTopicName' : 'playerTopicName'];
                if (this.currentTopic) {
                    name.textContent = this.currentTopic;
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            }

            updateTopicsHistory() {
                if (this.calledTopics.length === 0) {
                    this.ui.topicsHistory.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 1rem;">í˜¸ì¶œëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    this.ui.topicsHistory.innerHTML = [...this.calledTopics].reverse().slice(0, 10).map((topic, index) => 
                        `<div style="padding: 0.25rem 0; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between;">
                            <span>${topic}</span>
                            <span style="color: #94a3b8;">#${this.calledTopics.length - index}</span>
                        </div>`
                    ).join('');
                }
            }

            updateLeaderboard(leaderboard) {
                const container = this.ui.adminLeaderboard;
                if (leaderboard.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--text-light);">ğŸ‘¥ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
                    return;
                }
                container.innerHTML = leaderboard.map((player, index) => {
                    const rank = index + 1;
                    const isCurrentPlayer = player.id === this.playerId;
                    const isComplete = this.isBingoComplete(player.bingoLines);
                    const medals = { 1: 'ğŸ‘‘', 2: 'ğŸ¥ˆ', 3: 'ğŸ¥‰' };
                    const rankClasses = { 1: 'rank-1', 2: 'rank-2', 3: 'rank-3' };
                    return `
                        <div class="player-item ${isCurrentPlayer ? 'player-current' : ''}">
                            <div class="player-info">
                                <div class="player-rank ${rankClasses[rank] || 'rank-other'}">${rank}</div>
                                <div>
                                    <div style="font-weight: 600;">${player.name}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-light);">${player.bingoLines}ì¤„ ì™„ì„±</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                ${medals[rank] ? `<div style="font-size: 1.25rem; margin-bottom: 0.25rem;">${medals[rank]}</div>` : ''}
                                ${isComplete ? '<div class="bingo-badge">âœ… BINGO!</div>' : ''}
                            </div>
                        </div>`;
                }).join('');
            }

            updateBingoCard() {
                if (!this.playerCard.length) return;
                this.ui.playerBingoCard.innerHTML = this.playerCard.map(cell => {
                    let cellClass = 'bingo-cell';
                    let content = cell.topic;
                    if (cell.isCenter) {
                        cellClass += ' center';
                        content = '<div style="font-size: 1.25rem;">â­</div><div style="font-size: 0.75rem;">FREE</div>';
                    } else if (cell.marked) {
                        cellClass += ' marked';
                    }
                    return `<div class="${cellClass}">${content}</div>`;
                }).join('');
            }
        }

        // ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            new BingoGame();
        });
    </script>
</body>
</html>
